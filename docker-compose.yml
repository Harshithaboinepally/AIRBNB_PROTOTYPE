services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.0.1
    container_name: zookeeper_container
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - airbnb_network

  kafka:
    image: confluentinc/cp-kafka:7.0.1
    container_name: kafka_container
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - airbnb_network

  frontend-kafka-gateway:
    build:
      context: ./frontend-kafka-gateway
      dockerfile: Dockerfile
    container_name: frontend_kafka_gateway_container
    ports:
      - "5007:5007" # Expose the gateway port
    volumes:
      - ./frontend-kafka-gateway:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5007
      KAFKA_BROKERS: kafka:29092 # Kafka broker address within the Docker network
      JWT_SECRET: your_jwt_secret # Add this line to match auth-service
    depends_on:
      - kafka
    networks:
      - airbnb_network

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth_service_container
    volumes:
      - ./auth-service:/app
      - /app/node_modules # Prevents host's node_modules from overwriting container's
    environment:
      NODE_ENV: development
      PORT: 5001
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: auth-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
      JWT_SECRET: your_jwt_secret # Add JWT_SECRET here
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
    networks:
      - airbnb_network

  property-service:
    build:
      context: ./property-service
      dockerfile: Dockerfile
    container_name: property_service_container
    volumes:
      - ./property-service:/app
      - /app/node_modules
      - ./property-service/uploads/properties:/app/uploads/properties # Mount uploads for persistence and access
    environment:
      NODE_ENV: development
      PORT: 5002
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: property-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
      # In a more advanced setup, property-service might depend on auth-service
      # if it needs to call the auth-service to verify tokens/sessions.
      # For now, it might directly use session middleware for ownerId from its own session store.
    networks:
      - airbnb_network

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user_service_container
    volumes:
      - ./user-service:/app
      - /app/node_modules
      - ./user-service/uploads/profiles:/app/uploads/profiles # Mount uploads for profile pictures
    environment:
      NODE_ENV: development
      PORT: 5003
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: user-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
      # If user-service needs to interact with auth-service (e.g., to get user details),
      # you would uncomment the dependency here, and then implement inter-service communication.
      # - auth-service
    networks:
      - airbnb_network

  booking-service:
    build:
      context: ./booking-service
      dockerfile: Dockerfile
    container_name: booking_service_container
    volumes:
      - ./booking-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5004
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: booking-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
      # Booking service depends on property data (even if copied schemas for now)
      # and potentially user data for traveler/owner details.
      # If you were doing inter-service communication, you'd add dependencies here:
      # - property-service
      # - user-service
    networks:
      - airbnb_network

  favorite-service:
    build:
      context: ./favorite-service
      dockerfile: Dockerfile
    container_name: favorite_service_container
    volumes:
      - ./favorite-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5005
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: favorite-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
      # If favorite-service needs to interact with property-service (for instance, to get updated property details
      # beyond what's in its local schema copy), you'd uncomment the dependency here,
      # and then implement inter-service communication.
      # - property-service
    networks:
      - airbnb_network

  dashboard-service:
    build:
      context: ./dashboard-service
      dockerfile: Dockerfile
    container_name: dashboard_service_container
    volumes:
      - ./dashboard-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5006
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: dashboard-service-secret
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
      # The dashboard-service orchestrates data from other services.
      # While it currently uses copied schemas, if you transition to inter-service API calls,
      # you'd add dependencies here to ensure they start up before dashboard-service.
      # For example:
      # - auth-service
      # - property-service
      # - user-service
      # - booking-service
      # - favorite-service
    networks:
      - airbnb_network

  agent-service:
    build:
      context: ./agent-service
      dockerfile: Dockerfile
    container_name: agent_service_container
    ports:
      - "8001:8001"
    volumes:
      - ./agent-service:/app
    environment:
      DB_HOST: mongodb
      DB_NAME: airbnb_db
      DB_PORT: 27017
      KAFKA_BROKERS: kafka:29092 # Add Kafka brokers for consumer
    depends_on:
      - mongodb
      - kafka # Add kafka dependency
    networks:
      - airbnb_network

  nginx:
    image: nginx:latest
    container_name: nginx_gateway
    ports:
      - "5000:5000" # Nginx listens on host port 5000
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service
      - property-service
      - user-service
      - favorite-service
      - dashboard-service
      - frontend-kafka-gateway # Add dependency for the new gateway
    networks:
      - airbnb_network

  mongodb:
    image: mongo:latest
    container_name: mongodb_container
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - airbnb_network

  ollama:
    image: ollama/ollama:latest # Use the official Ollama Docker image
    container_name: ollama_container
    ports:
      - "11434:11434" # Default Ollama port
    volumes:
      - ollama_data:/root/.ollama # Persist Ollama models and data
    # environment:
    # Optional: specify models to pull on startup (e.g., 'llama2', 'mistral')
    # OLLAMA_MODELS: "llama2,mistral"
    networks:
      - airbnb_network

volumes:
  mongodb_data:
  ollama_data:
  property_uploads_data:

networks:
  airbnb_network:
    driver: bridge
