services:
  # ==================== INFRASTRUCTURE ====================
  
  mongodb:
    image: mongo:latest
    container_name: mongodb_container
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - airbnb_network
    command: mongod --bind_ip_all
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 20s

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper_container
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - airbnb_network

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka_container
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - airbnb_network
    healthcheck:
      test: kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  ollama:
    image: ollama/ollama:latest
    container_name: ollama_container
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - airbnb_network

  # ==================== MICROSERVICES ====================

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth_service_container
    volumes:
      - ./auth-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5001
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: auth-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - kafka
    networks:
      - airbnb_network

  property-service:
    build:
      context: ./property-service
      dockerfile: Dockerfile
    container_name: property_service_container
    volumes:
      - ./property-service:/app
      - /app/node_modules
      - ./property-service/uploads/properties:/app/uploads/properties
    environment:
      NODE_ENV: development
      PORT: 5002
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: property-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - kafka
    networks:
      - airbnb_network

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user_service_container
    volumes:
      - ./user-service:/app
      - /app/node_modules
      - ./user-service/uploads/profiles:/app/uploads/profiles
    environment:
      NODE_ENV: development
      PORT: 5003
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: user-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - kafka
    networks:
      - airbnb_network

  booking-service:
    build:
      context: ./booking-service
      dockerfile: Dockerfile
    container_name: booking_service_container
    volumes:
      - ./booking-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5004
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: booking-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - airbnb_network

  favorite-service:
    build:
      context: ./favorite-service
      dockerfile: Dockerfile
    container_name: favorite_service_container
    volumes:
      - ./favorite-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5005
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: favorite-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - kafka
    networks:
      - airbnb_network

  dashboard-service:
    build:
      context: ./dashboard-service
      dockerfile: Dockerfile
    container_name: dashboard_service_container
    volumes:
      - ./dashboard-service:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      PORT: 5006
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: airbnb_db
      SESSION_SECRET: dashboard-service-secret
      JWT_SECRET: your-jwt-secret-key
      FRONTEND_URL: "http://localhost:3000"
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - kafka
    networks:
      - airbnb_network

  agent-service:
    build:
      context: ./agent-service
      dockerfile: Dockerfile
    container_name: agent_service_container
    ports:
      - "8001:8001"
    volumes:
      - ./agent-service:/app
    environment:
      DB_HOST: mongodb
      DB_NAME: airbnb_db
      DB_PORT: 27017
      OLLAMA_HOST: ollama
      OLLAMA_PORT: 11434
      KAFKA_BROKER: kafka:9092
    depends_on:
      - mongodb
      - ollama
      - kafka
    networks:
      - airbnb_network

  # ==================== API GATEWAY ====================

  nginx:
    image: nginx:latest
    container_name: nginx_gateway
    ports:
      - "5000:5000"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service
      - property-service
      - user-service
      - booking-service
      - favorite-service
      - dashboard-service
    networks:
      - airbnb_network

# ==================== VOLUMES ====================

volumes:
  mongodb_data:
  ollama_data:
  property_uploads_data:

# ==================== NETWORKS ====================

networks:
  airbnb_network:
    driver: bridge